function showDiffs(){$("#remoteDetails .merge").each(function(){var e=$(this).attr("class").split(/\s+/),a=e[e.length-1],t=$("#localDetails ."+a+" .mergeDisplay"),s=$("#remoteDetails ."+a+" .mergeDisplay"),l=runDiff(t,s,s);l&&(addMergeButton(a),t.addClass("remoteChanged"),s.addClass("remoteChanged"),changedElements.push(a))}),$("#localDetails .merge").each(function(){var e=$(this).attr("class").split(/\s+/),a=e[e.length-1],t=$("#localDetails ."+a+" .mergeDisplay"),s=$("#remoteDetails ."+a+" .mergeDisplay"),l=runDiff(t,s,s);l&&!t.hasClass("remoteChanged")&&(t.addClass("remoteChanged"),s.addClass("remoteChanged"))}),mergeListen(),saveListen()}function runDiff(e,a,t){var s=e.text().trim().replace(/(\r\n|\n|\r)/gm,""),l=a.text().trim().replace(/(\r\n|\n|\r)/gm,"");if(s===l)return!1;dmp.Diff_Timeout=1,dmp.Diff_EditCost=10;var n=dmp.diff_main(s,l);dmp.diff_cleanupEfficiency(n);var r=dmp.diff_prettyHtml(n);return t.html(r),r?!0:!1}function addMergeButton(e){$("#localDetails ."+e).prepend("<button class='btn mergeBtnL'><i class='fa fa-square-o '></i> Use original</button>"),$("#localDetails ."+e).prepend("<button class='btn mergeBtnR'><i class='fa fa-square-o '></i> Use crowdsourced</button>")}function mergeListen(){$("button.mergeBtnR").click(function(){var e=$(this).parent().attr("class").split(/\s+/),a=e[e.length-1].trim(),t=$("#remoteDetails ."+a+" .mergeOriginal").html(),s=$("#localDetails ."+a+" .mergeDisplay"),l=$.inArray(a,changedElements);l>-1&&changedElements.splice(l,1),replacements[a]=t.trim(),$(this).children("i").attr("class","fa fa-check-square-o"),$("#localDetails ."+a+" .mergeBtnL i").attr("class","fa fa-square-o"),$("#localDetails ."+a+" .mergeBtnL").css("background-color","#ddd"),$("#localDetails ."+a+" .mergeBtnL").prop("disabled",!1),flashText(s,t,this,!0)}),$("button.mergeBtnL").click(function(){var e=$(this).parent().attr("class").split(/\s+/),a=e[e.length-1].trim(),t=$("#localDetails ."+a+" .mergeOriginal").html(),s=$(this).next(),l=$.inArray(a,changedElements);l>-1&&changedElements.splice(l,1),replacements[a]=t.trim(),$(this).children("i").attr("class","fa fa-check-square-o"),$("#localDetails ."+a+" .mergeBtnR i").attr("class","fa fa-square-o"),$("#localDetails ."+a+" .mergeBtnR").css("background-color","#ddd"),$("#localDetails ."+a+" .mergeBtnR").prop("disabled",!1);var n=s.html();flashText(s,t,this,t!==n)})}function flashText(e,a,t,s){var l=s?300:0;e.fadeOut(l,function(){e.empty(),e.html(a),e.fadeIn(l),$(t).css("background-color","green"),$(t).prop("disabled",!0)})}function saveListen(){$("#saveMerge").click(function(){$("mergeFeedback").empty(),changedElements.length>0?$("#mergeFeedback").html("<span class='error'>You must select an option for all fields. Choose either crowdsourced or original</span>"):($("#mergeFeedback").html("<span class='success'><i class='fa fa-spinner fa-spin'></i> Merging changes</span>"),$("#saveMerge").prop("disabled",!0),$.ajax({cache:!1,async:!0,type:"POST",data:{replacements:JSON.stringify(replacements)},url:window.location,complete:function(e){$("#mergeFeedback").html("<span class='success'>Saved</span>")}}))})}var dmp=null,changedElements=[],replacements={};$(document).ready(function(){dmp=new diff_match_patch,showDiffs()});