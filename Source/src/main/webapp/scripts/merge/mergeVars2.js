function showDiffs(){$("#remoteDetails .merge").each(function(){var e=$(this).attr("class").split(/\s+/),a=e[e.length-1],s=$("#localDetails ."+a+" .mergeDisplay"),t=$("#remoteDetails ."+a+" .mergeDisplay"),l=runDiff(s,t,t);l&&(addMergeButton(a),s.addClass("remoteChanged"),t.addClass("remoteChanged"),changedElements.push(a))}),$("#localDetails .merge").each(function(){var e=$(this).attr("class").split(/\s+/),a=e[e.length-1],s=$("#localDetails ."+a+" .mergeDisplay"),t=$("#remoteDetails ."+a+" .mergeDisplay"),l=runDiff(s,t,t);l&&!s.hasClass("remoteChanged")&&(s.addClass("remoteChanged"),t.addClass("remoteChanged"))}),mergeListen(),saveListen()}function runDiff(e,a,s){var t=e.text().trim().replace(/(\r\n|\n|\r)/gm,""),l=a.text().trim().replace(/(\r\n|\n|\r)/gm,"");if(t===l)return!1;dmp.Diff_Timeout=1,dmp.Diff_EditCost=10;var r=dmp.diff_main(t,l);dmp.diff_cleanupEfficiency(r);var n=dmp.diff_prettyHtml(r);return s.html(n),n?!0:!1}function addMergeButton(e){$("#localDetails ."+e).prepend("<button class='btn mergeBtnL'><i class='fa fa-square-o '></i> Use original</button>"),$("#localDetails ."+e).prepend("<button class='btn mergeBtnR'><i class='fa fa-square-o '></i> Use crowdsourced</button>")}function mergeListen(){$("button.mergeBtnR").click(function(){var e=$(this).parent().attr("class").split(/\s+/),a=e[e.length-1].trim(),s=$("#remoteDetails ."+a+" .mergeOriginal").html(),t=$("#localDetails ."+a+" .mergeDisplay"),l=$.inArray(a,changedElements);l>-1&&changedElements.splice(l,1),replacements[a]=s.trim(),$(this).children("i").attr("class","fa fa-check-square-o"),$("#localDetails ."+a+" .mergeBtnL i").attr("class","fa fa-square-o"),$("#localDetails ."+a+" .mergeBtnL").css("background-color","#ddd"),$("#localDetails ."+a+" .mergeBtnL").prop("disabled",!1),flashText(t,s,this,!0)}),$("button.mergeBtnL").click(function(){var e=$(this).parent().attr("class").split(/\s+/),a=e[e.length-1].trim(),s=$("#localDetails ."+a+" .mergeOriginal").html(),t=$(this).next(),l=$.inArray(a,changedElements);l>-1&&changedElements.splice(l,1),replacements[a]=s.trim(),$(this).children("i").attr("class","fa fa-check-square-o"),$("#localDetails ."+a+" .mergeBtnR i").attr("class","fa fa-square-o"),$("#localDetails ."+a+" .mergeBtnR").css("background-color","#ddd"),$("#localDetails ."+a+" .mergeBtnR").prop("disabled",!1);var r=t.html();flashText(t,s,this,s!==r)})}function flashText(e,a,s,t){e.html(a);var l=t?300:0;return e.fadeOut(l,function(){e.empty(),e.html(a),e.fadeIn(l),$(s).css("background-color","green"),$(s).prop("disabled",!0)}),!1}function saveListen(){$("#saveMerge").click(function(){if($("mergeFeedback").empty(),changedElements.length>0)$("#mergeFeedback").html("<span class='error'>You must select an option for all fields. Choose either crowdsourced or original</span>");else{console.log(JSON.stringify(replacements));var e="/ced2ar-web/edit/codebooks/"+baseHandle+"/v/"+version+"/vars/"+varName+"/merge";console.log(e),$("#mergeFeedback").html("<span class='success'><i class='fa fa-spinner fa-spin'></i> Merging changes</span>"),$("#saveMerge").prop("disabled",!0),$.ajax({cache:!1,async:!0,type:"POST",data:{replacements:JSON.stringify(replacements)},url:e,complete:function(e){$("#mergeFeedback").html("<span class='success'>Saved</span>")}})}})}var dmp=null,changedElements=[],replacements={},baseHandle="",version="",varName="";$(document).ready(function(){baseHandle=$("#baseHandle").val(),version=$("#version").val(),varName=$("#varName").val(),dmp=new diff_match_patch,showDiffs(),console.log("started diff")});