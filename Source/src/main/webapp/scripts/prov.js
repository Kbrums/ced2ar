function buildGraph(t){var e=[],a=[],i=[];return $.each(t.nodes,function(t,a){e.push(makeElement(t,a[0],a[1],a[2])),i.push(t)}),$.each(t.edges,function(t,e){i.indexOf(e[0])>-1&&a.push(makeLink(e[0],e[1],e[2],e[3]))}),e.concat(a)}function makeLink(t,e,a,i){""===i&&(i="No description found");var r=!0;label="",0===a?label="Generated By":1==a?label="Used":2==a?(label="Associated With",r=!1):3==a?(label="Attributed To",r=!1):4==a?label="Derived From...":5==a&&(label="Acted on Behalf Of",r=!1);var n=new joint.dia.Link({source:{id:e},target:{id:t},attrs:{".connection":{stroke:"#777","class":"provLink provL"+a},".marker-target":{fill:"#333","stroke-width":"0",d:"M 12 0 L 0 6 L 12 12 z","class":"provL"+a}},labels:[{position:.5,attrs:{text:{text:label,"class":"provLD"+a,"stroke-width":5,"data-toggle":"tooltip","data-original-title":i},rect:{stroke:"#eee",fill:"#eee","stroke-width":10,rx:1,ry:1}}}],smooth:r,manhattan:!1});return n}function makeElement(t,e,a,i){var r=_.max(e.split("\n"),function(t){return t.length}).length;8>=r&&(r=1.2*r);var n=14,o=.9*(n*(.6*r+1)),l=1.1*((e.split("\n").length+1)*n),s=null;return s=2==a?new joint.shapes.basic.Rect({id:t,size:{width:o,height:l},attrs:{text:{"class":"provO1",text:e,"font-size":n,fill:"#FFF"},rect:{"class":"provO1",width:o,height:l,rx:3,ry:3,stroke:"#d03d00",fill:"#d03d00","stroke-width":2}}}):1==a?new joint.shapes.basic.Rect({id:t,size:{width:o,height:l},attrs:{text:{"class":"provO2",text:e,"font-size":n,fill:"#FFF"},rect:{"class":"provO2",width:o,height:l,rx:15,ry:15,stroke:"#00d093",fill:"#00d093","stroke-width":2}}}):new joint.shapes.basic.Rect({id:t,size:{width:o,height:l},attrs:{text:{"class":"provO3",text:e,"font-size":n,fill:"#FFF"},rect:{"class":"provO3",width:o,height:l,rx:6,ry:6,stroke:"#0093d0",fill:"#0093d0","stroke-width":2}}}),""!==i&&s.attr({text:{"class":"dynamicDesc",onclick:'window.location = "'+i+'";'}}),s}function legend(){var t=new joint.dia.Graph;new joint.dia.Paper({el:$("#graphL"),width:50,height:300,gridSize:1,model:t,perpendicularLinks:!1});var e=function(){var t=null;return $.ajax({async:!1,global:!1,url:baseURI+"/json/provLegend.json",dataType:"json",success:function(e){t=e}}),t}(),a=buildGraph(e);t.resetCells(a),joint.layout.DirectedGraph.layout(t,{setLinkVertices:!0,rankDir:"LR",rankSep:25,edgeSep:25,nodeSep:25}),$("#graphL svg").attr("width","100%"),$("#graphL svg").attr("height","100%")}function build(t){provData=function(){var e=null;return $.ajax({async:!1,global:!1,url:baseURI+"/prov/data?short="+t,dataType:"json",success:function(t){e=t}}),e}();var e=115,a=100;"1"==t&&(e=150,a=75);var i=buildGraph(provData);graph.resetCells(i);var r=joint.layout.DirectedGraph.layout(graph,{setLinkVertices:!0,rankDir:"TB",rankSep:e,edgeSep:125,nodeSep:a}),n=r.width+100,o=r.height+50;$("#graph svg").attr("width",n),$("#graph svg").attr("height",o),$("g").mousedown(function(){return!1}),$(document).ready(function(){$(".provLD4").tooltip({container:"body",placement:"top"})})}baseURI=$("#meta_uri").html(),$("#filter").empty();var htmlButtons="<h2 id='provHeader'>Prov</h2><a id='provExpand' class='pL provButton' href='#'>View full graph</a><a id='provSimple' class='pL provButton' href='#'>View compact graph</a><div id='graphL'><p>Legend</p></div>";$("#filter").append(htmlButtons);var w=.9*$("#main").width();900>w&&(w=900);var graph=new joint.dia.Graph;new joint.dia.Paper({el:$("#graph"),width:w,height:1500,gridSize:1,model:graph,perpendicularLinks:!1}),legend(),build("1"),$("#provExpand").click(function(){build("0"),$("#provExpand").css("display","none"),$("#provSimple").css("display","block")}),$("#provSimple").click(function(){build("1"),$("#provExpand").css("display","block"),$("#provSimple").css("display","none")});